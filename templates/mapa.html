<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiciSegura - Mapa en Vivo</title>
    
    <!-- Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; }
        
        /* Ajuste: El mapa ahora ocupa el 100% de su contenedor padre, no de la ventana */
        #map { 
            height: 100%; 
            width: 100%; 
            z-index: 1;
        }

        /* Cursor espec铆fico para modo reporte */
        .cursor-crosshair {
            cursor: crosshair !important;
        }

        .custom-pin {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .custom-pin:hover { transform: scale(1.1); z-index: 1000 !important; }
        .custom-pin i { color: white; font-size: 16px; }

        /* Colores */
        .pin-parking { background-color: #10b981; }
        .pin-shop { background-color: #3b82f6; }
        .pin-hazard { background-color: #ef4444; }

        /* Marcador de Usuario (Punto Azul Pulsante) */
        .user-location-marker {
            width: 20px;
            height: 20px;
            background-color: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse-blue 2s infinite;
        }
        
        @keyframes pulse-blue {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Animaci贸n Modal */
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-100 font-sans flex flex-col h-screen">

    <!-- App Navbar -->
    <nav class="bg-slate-900 text-white h-16 flex-none flex items-center justify-between px-4 shadow-lg z-50 relative">
        <a href="/" class="flex items-center gap-2 hover:opacity-80 transition">
            <i class="fa-solid fa-arrow-left text-gray-400"></i>
            <span class="font-bold text-lg tracking-tight ml-2">Bici<span class="text-emerald-400">Segura</span></span>
        </a>
        <div class="flex gap-4 text-sm font-medium">
            <button id="btn-reportar" onclick="toggleReportMode()" class="bg-emerald-500 hover:bg-emerald-600 px-3 py-1 rounded-full text-white transition shadow-md flex items-center gap-2">
                <i class="fas fa-plus"></i> <span id="btn-reportar-text">Reportar</span>
            </button>
        </div>
    </nav>

    <!-- Layout Principal: Lista + Mapa -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Secci贸n 1: Lista de Lugares (Accesible) -->
        <aside class="w-80 bg-white border-r border-gray-200 overflow-y-auto hidden md:block z-20 shadow-xl" aria-label="Lista de puntos de inter茅s">
            <div class="p-4 bg-gray-50 border-b border-gray-200 sticky top-0">
                <h2 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                    <i class="fas fa-list text-emerald-500"></i> Lista de Lugares
                </h2>
                <p class="text-xs text-gray-500 mt-1">Haz clic para centrar en el mapa</p>
            </div>
            <ul id="places-list" class="divide-y divide-gray-100">
                <!-- Los elementos se a帽adir谩n aqu铆 din谩micamente -->
            </ul>
        </aside>

        <!-- Secci贸n 2: Contenedor del Mapa -->
        <main class="flex-1 relative h-full">
            <div id="map" role="application" aria-label="Mapa interactivo de ciclismo urbano"></div>

            <!-- Bot贸n Flotante de Geolocalizaci贸n -->
            <button id="btn-geo" class="absolute bottom-8 right-6 z-[400] w-14 h-14 bg-white text-gray-700 rounded-full shadow-xl flex items-center justify-center hover:bg-gray-50 hover:text-emerald-600 transition-all focus:outline-none border border-gray-100" title="Centrar en mi ubicaci贸n" aria-label="Centrar mapa en mi ubicaci贸n actual">
                <i class="fas fa-location-crosshairs text-xl"></i>
            </button>

            <!-- Leyenda Flotante -->
            <div class="absolute bottom-8 left-4 z-[400] bg-white/95 backdrop-blur p-4 rounded-xl shadow-xl border border-gray-200 max-w-xs" aria-label="Leyenda del mapa">
                <h3 class="font-bold text-gray-800 mb-2 text-xs uppercase tracking-wide">Puntos de Inter茅s</h3>
                <div class="space-y-2 text-xs">
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-500 block"></span><span class="text-gray-600">Estacionamiento</span></div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500 block"></span><span class="text-gray-600">Taller</span></div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500 block"></span><span class="text-gray-600">Peligro</span></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Reporte -->
    <div id="modal-reporte" class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden modal-enter">
            <div class="bg-slate-900 p-4 flex justify-between items-center">
                <h3 id="modal-title" class="text-white font-bold"><i class="fas fa-map-pin mr-2 text-emerald-400"></i>Nuevo Reporte</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white" aria-label="Cerrar modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo de Reporte</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="selectType('hazard')" id="type-hazard" class="type-btn p-2 rounded-lg border-2 border-transparent bg-red-50 text-red-600 hover:bg-red-100 flex flex-col items-center gap-1 transition" aria-pressed="true">
                            <i class="fas fa-triangle-exclamation"></i>
                            <span class="text-[10px] font-bold">Peligro</span>
                        </button>
                        <button type="button" onclick="selectType('parking')" id="type-parking" class="type-btn p-2 rounded-lg border-2 border-transparent bg-emerald-50 text-emerald-600 hover:bg-emerald-100 flex flex-col items-center gap-1 transition" aria-pressed="false">
                            <i class="fas fa-square-parking"></i>
                            <span class="text-[10px] font-bold">Parking</span>
                        </button>
                        <button type="button" onclick="selectType('shop')" id="type-shop" class="type-btn p-2 rounded-lg border-2 border-transparent bg-blue-50 text-blue-600 hover:bg-blue-100 flex flex-col items-center gap-1 transition" aria-pressed="false">
                            <i class="fas fa-wrench"></i>
                            <span class="text-[10px] font-bold">Taller</span>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label for="report-title" class="block text-xs font-bold text-gray-500 uppercase mb-1">T铆tulo</label>
                    <input type="text" id="report-title" placeholder="Ej: Bache profundo..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                </div>

                <div>
                    <label for="report-desc" class="block text-xs font-bold text-gray-500 uppercase mb-1">Descripci贸n</label>
                    <textarea id="report-desc" rows="2" placeholder="Detalles adicionales..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm"></textarea>
                </div>

                <button id="btn-save-modal" onclick="saveReport()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2">
                    Guardar en Mapa
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        // --- Variables Globales ---
        const map = L.map('map').setView([32.5149, -117.0382], 14);
        let isReporting = false;
        let tempLatLng = null;
        let selectedType = 'hazard'; // Default
        let userMarker = null;

        // --- Configuraci贸n Inicial del Mapa ---
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 20
        }).addTo(map);

        // --- Accesibilidad: Etiquetas ARIA para controles del mapa ---
        map.whenReady(() => {
            const zoomInBtn = document.querySelector('.leaflet-control-zoom-in');
            const zoomOutBtn = document.querySelector('.leaflet-control-zoom-out');
            if(zoomInBtn) zoomInBtn.setAttribute('aria-label', 'Acercar mapa');
            if(zoomOutBtn) zoomOutBtn.setAttribute('aria-label', 'Alejar mapa');
        });

        // --- Datos Iniciales ---
        const puntosInteres = [
            { id: 1, lat: 32.5250, lng: -117.0350, tipo: 'parking', titulo: 'Estacionamiento Plaza R铆o', desc: 'Vigilancia 24h.', icono: 'fa-square-parking' },
            { id: 2, lat: 32.5120, lng: -117.0200, tipo: 'shop', titulo: 'Taller "El Rayo"', desc: 'Reparaciones r谩pidas.', icono: 'fa-wrench' },
            { id: 3, lat: 32.5190, lng: -117.0450, tipo: 'hazard', titulo: 'Bache Peligroso', desc: 'Carril bloqueado.', icono: 'fa-triangle-exclamation' },
            { id: 4, lat: 32.5320, lng: -117.0150, tipo: 'parking', titulo: 'BiciRack CECUT', desc: 'Entrada principal.', icono: 'fa-bicycle' }
        ];

        // --- Funciones de Renderizado ---
        function getIconClass(tipo) {
            if (tipo === 'parking') return 'fa-square-parking';
            if (tipo === 'shop') return 'fa-wrench';
            return 'fa-triangle-exclamation';
        }

        function crearIcono(tipo, faIconClass) {
            return L.divIcon({
                className: 'custom-icon-container',
                html: `<div class="custom-pin pin-${tipo} w-10 h-10"><i class="fa-solid ${faIconClass}"></i></div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -25]
            });
        }

        // --- Agregar marcador al mapa Y a la lista ---
        function addMarkerToMap(punto) {
            const icono = crearIcono(punto.tipo, punto.icono);
            const marker = L.marker([punto.lat, punto.lng], { icon: icono }).addTo(map);
            
            // Popup Funcional con Navegaci贸n
            const popupContent = document.createElement('div');
            popupContent.className = 'font-sans text-center min-w-[200px]';
            popupContent.innerHTML = `
                <h3 class="font-bold text-sm text-gray-800">${punto.titulo}</h3>
                <p class="text-xs text-gray-600 my-2">${punto.desc}</p>
                <button class="bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-bold px-4 py-2 rounded-full w-full transition flex items-center justify-center gap-2">
                    <i class="fas fa-location-arrow"></i> Ir Ahora
                </button>
            `;
            
            // Event Listener para el bot贸n "Ir Ahora"
            popupContent.querySelector('button').addEventListener('click', () => {
                navigateTo(punto.lat, punto.lng);
            });

            marker.bindPopup(popupContent);

            // --- Agregar a la lista lateral ---
            addToList(punto, marker);
        }

        function addToList(punto, marker) {
            const list = document.getElementById('places-list');
            const li = document.createElement('li');
            li.className = "p-4 hover:bg-blue-50 cursor-pointer transition border-l-4 border-transparent hover:border-blue-500 group";
            
            // Determinar color del icono en la lista basado en tipo
            let iconColorClass = "text-gray-400";
            if (punto.tipo === 'parking') iconColorClass = "text-emerald-500";
            if (punto.tipo === 'shop') iconColorClass = "text-blue-500";
            if (punto.tipo === 'hazard') iconColorClass = "text-red-500";

            li.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="mt-1 ${iconColorClass} group-hover:scale-110 transition-transform">
                        <i class="fas ${punto.icono}"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm text-gray-800 group-hover:text-blue-600">${punto.titulo}</h4>
                        <p class="text-xs text-gray-500 mt-1">Punto en Lat: ${punto.lat.toFixed(4)}, Lng: ${punto.lng.toFixed(4)}</p>
                    </div>
                </div>
            `;

            // Accesibilidad: permitir navegar con teclado
            li.setAttribute('tabindex', '0');
            li.setAttribute('role', 'button');
            li.setAttribute('aria-label', `Ver ubicaci贸n de ${punto.titulo}`);

            // Evento click en la lista -> Mueve el mapa
            li.addEventListener('click', () => {
                map.flyTo([punto.lat, punto.lng], 16, { duration: 1.5 });
                marker.openPopup();
                // Scroll suave en m贸viles si es necesario
                document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
            });

            // Evento enter (accesibilidad)
            li.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') li.click();
            });

            list.appendChild(li);
        }

        // Cargar puntos iniciales
        puntosInteres.forEach(addMarkerToMap);

        // --- Funcionalidad: Navegaci贸n (Ir Ahora) ---
        function navigateTo(destLat, destLng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=bicycling`;
            window.open(url, '_blank');
        }

        // --- Funcionalidad: Reportar (A帽adir Punto) ---
        function toggleReportMode() {
            isReporting = !isReporting;
            const btn = document.getElementById('btn-reportar');
            const btnText = document.getElementById('btn-reportar-text');
            const mapContainer = document.getElementById('map');

            if (isReporting) {
                btn.classList.replace('bg-emerald-500', 'bg-red-500');
                btn.classList.replace('hover:bg-emerald-600', 'hover:bg-red-600');
                btn.innerHTML = '<i class="fas fa-times"></i> Cancelar';
                mapContainer.classList.add('cursor-crosshair');
                
                const toast = L.tooltip({ 
                    permanent: true, 
                    direction: 'center', 
                    className: 'bg-slate-900 text-white border-0 font-bold px-3 py-2 rounded shadow-xl' 
                })
                .setContent("Haz clic en el mapa para colocar el reporte")
                .setLatLng(map.getCenter())
                .addTo(map);
                
                map.reportToast = toast;

            } else {
                resetReportUI();
            }
        }

        function resetReportUI() {
            isReporting = false;
            const btn = document.getElementById('btn-reportar');
            const mapContainer = document.getElementById('map');
            
            btn.className = "bg-emerald-500 hover:bg-emerald-600 px-3 py-1 rounded-full text-white transition shadow-md flex items-center gap-2";
            btn.innerHTML = '<i class="fas fa-plus"></i> <span id="btn-reportar-text">Reportar</span>';
            mapContainer.classList.remove('cursor-crosshair');
            
            if (map.reportToast) map.removeLayer(map.reportToast);
        }

        // Manejador de clics en el mapa
        map.on('click', function(e) {
            if (!isReporting) return;

            tempLatLng = e.latlng;
            openModal();
            resetReportUI(); 
        });

        // --- L贸gica del Modal y Backend ---
        function openModal() {
            document.getElementById('modal-reporte').classList.remove('hidden');
            selectType('hazard');
            document.getElementById('report-title').value = '';
            document.getElementById('report-desc').value = '';
            // Accesibilidad: Foco al primer input
            setTimeout(() => document.getElementById('report-title').focus(), 100);
        }

        function closeModal() {
            document.getElementById('modal-reporte').classList.add('hidden');
        }

        function selectType(type) {
            selectedType = type;
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-1', 'ring-slate-400');
                btn.setAttribute('aria-pressed', 'false');
            });
            const activeBtn = document.getElementById(`type-${type}`);
            activeBtn.classList.add('ring-2', 'ring-offset-1', 'ring-slate-400');
            activeBtn.setAttribute('aria-pressed', 'true');
        }

        // --- FUNCIN CLAVE: Guardar Reporte con FETCH ---
        function saveReport() {
            const title = document.getElementById('report-title').value;
            const desc = document.getElementById('report-desc').value;

            if (!title) {
                alert("Por favor escribe un t铆tulo para el reporte.");
                return;
            }

            const btnSave = document.getElementById('btn-save-modal');
            const originalText = btnSave.innerHTML;
            btnSave.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Guardando...';
            btnSave.disabled = true;

            const payload = {
                lat: tempLatLng.lat,
                lng: tempLatLng.lng,
                tipo: selectedType,
                titulo: title,
                desc: desc
            };

            fetch('/guardar_punto', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'ok') {
                    const newPoint = {
                        id: Date.now(),
                        lat: tempLatLng.lat,
                        lng: tempLatLng.lng,
                        tipo: selectedType,
                        titulo: title,
                        desc: desc || "Sin descripci贸n",
                        icono: getIconClass(selectedType)
                    };

                    addMarkerToMap(newPoint); // Esto tambi茅n lo agregar谩 a la lista
                    closeModal();

                    const toast = L.tooltip({ 
                        permanent: false, 
                        direction: 'top', 
                        className: 'bg-emerald-500 text-white border-0 font-bold px-2 py-1 rounded' 
                    })
                    .setContent("隆Reporte guardado con 茅xito!")
                    .setLatLng(tempLatLng)
                    .addTo(map);
                    
                    setTimeout(() => map.removeLayer(toast), 2000);
                } else {
                    alert('Error en el servidor');
                }
            })
            .catch(err => {
                console.error(err);
                alert("No se pudo conectar con el servidor.");
            })
            .finally(() => {
                btnSave.innerHTML = originalText;
                btnSave.disabled = false;
            });
        }

        // --- Geolocalizaci贸n ---
        const btnGeo = document.getElementById('btn-geo');

        btnGeo.addEventListener('click', () => {
            const originalIcon = btnGeo.innerHTML;
            btnGeo.innerHTML = '<i class="fas fa-circle-notch fa-spin text-emerald-600"></i>';
            btnGeo.disabled = true;

            if (!navigator.geolocation) {
                alert("Geolocalizaci贸n no soportada");
                btnGeo.innerHTML = originalIcon;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const userLatLng = [latitude, longitude];

                    map.flyTo(userLatLng, 16);

                    if (userMarker) map.removeLayer(userMarker);

                    const userIcon = L.divIcon({
                        className: 'custom-user-marker',
                        html: '<div class="user-location-marker"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    const mensajeUsuario = `
                        <div class="text-center p-1">
                            <h3 class="font-bold text-emerald-600 mb-1 text-sm">隆Est谩s aqu铆! </h3>
                            <p class="text-gray-600 text-xs leading-relaxed">
                                Desde aqu铆 puedes explorar rutas.
                            </p>
                        </div>
                    `;

                    userMarker = L.marker(userLatLng, { icon: userIcon })
                        .addTo(map)
                        .bindPopup(mensajeUsuario)
                        .openPopup();

                    btnGeo.innerHTML = '<i class="fas fa-location-arrow text-emerald-600"></i>';
                    btnGeo.disabled = false;
                },
                (error) => {
                    console.error("Error geo:", error);
                    btnGeo.innerHTML = '<i class="fas fa-eye-slash text-red-500"></i>';
                    setTimeout(() => { btnGeo.innerHTML = originalIcon; btnGeo.disabled = false; }, 2000);
                }
            );
        });
    </script>
</body>
</html>